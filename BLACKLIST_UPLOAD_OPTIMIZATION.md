# تحسين رفع ملفات Blacklist للأرقام الكبيرة

## المشكلة الأصلية
كان السيرفر يواجه مشكلة في معالجة الملفات الكبيرة (1500+ سطر) مما يؤدي إلى:
- Worker timeout
- استهلاك ذاكرة عالية
- فشل في المعالجة

## الحلول المطبقة

### 1. Batch Processing
- معالجة الملفات في مجموعات صغيرة (100 سجل لكل مرة)
- تقليل استهلاك الذاكرة
- تحسين الأداء

### 2. Async Processing للملفات الكبيرة
- معالجة غير متزامنة للملفات الكبيرة
- إرجاع job ID فوري
- تتبع التقدم في الوقت الفعلي

### 3. تحسين استعلامات قاعدة البيانات
- استخدام `bulk_create` بدلاً من `create` متعدد
- استعلامات مجمعة للتحقق من الوجود
- تقليل عدد استعلامات قاعدة البيانات

### 4. تحسينات إضافية
- إعدادات cache للـ async processing
- حدود رفع الملفات
- تنظيف الملفات المؤقتة

## API Endpoints الجديدة

### 1. رفع عادي (محسن)
```
POST /api/blacklisted-ids/upload/
```
- معالجة فورية للملفات الصغيرة
- batch processing محسن

### 2. رفع غير متزامن
```
POST /api/blacklisted-ids/upload-async/
```
- للملفات الكبيرة
- إرجاع job ID فوري
- معالجة في الخلفية

### 3. تتبع الحالة
```
GET /api/blacklisted-ids/upload-status/{job_id}/
```
- تتبع تقدم المعالجة
- عرض الإحصائيات
- حالة الانتهاء

## الواجهة الأمامية

### الميزات الجديدة
- كشف تلقائي للملفات الكبيرة
- خيار المعالجة غير المتزامنة
- شريط تقدم في الوقت الفعلي
- عرض حالة مفصلة

### استخدام الواجهة
1. اختيار الملف
2. النظام يكتشف تلقائياً إذا كان الملف كبيراً
3. عرض تحذير للملفات الكبيرة
4. خيار إجبار المعالجة غير المتزامنة
5. تتبع التقدم في الوقت الفعلي

## إعدادات Django المحسنة

### Cache Configuration
```python
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
        'LOCATION': 'unique-snowflake',
        'TIMEOUT': 3600,
        'OPTIONS': {
            'MAX_ENTRIES': 1000,
        }
    }
}
```

### File Upload Settings
```python
FILE_UPLOAD_MAX_MEMORY_SIZE = 10 * 1024 * 1024  # 10MB
DATA_UPLOAD_MAX_MEMORY_SIZE = 10 * 1024 * 1024  # 10MB
```

## الأداء المحسن

### قبل التحسين
- معالجة 1500 سطر في طلب واحد
- استعلامات متعددة لقاعدة البيانات
- استهلاك ذاكرة عالي
- timeout errors

### بعد التحسين
- معالجة في مجموعات صغيرة (100 سجل)
- استعلامات مجمعة
- معالجة غير متزامنة للملفات الكبيرة
- تتبع التقدم في الوقت الفعلي
- تنظيف تلقائي للملفات المؤقتة

## الاستخدام

### للملفات الصغيرة (< 50KB)
- معالجة فورية
- نتائج فورية

### للملفات الكبيرة (> 50KB)
- معالجة غير متزامنة
- تتبع التقدم
- نتائج عند الانتهاء

## ملاحظات مهمة
- الملفات المؤقتة تُحذف تلقائياً
- حالة المعالجة تُحفظ في cache لمدة ساعة
- يمكن تتبع عدة عمليات رفع في نفس الوقت
- النظام يتعامل مع الأخطاء بشكل آمن
